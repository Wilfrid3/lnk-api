name: Deploy YamoHub API

on:
  push:
    branches: ["production"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ghcr.io/wilfrid3/lnk-api:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME .

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "wilfrid3" --password-stdin

      - name: Push image to GHCR
        run: |
          docker push $IMAGE_NAME

      - name: Generate .env.production
        run: |
          set -euo pipefail
          echo "Generating .env.production (local workspace)..."
          rm -f .env.production
          # Basic app env

          # MongoDB
          echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> .env.production

          # JWT
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.production
          echo "JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION }}" >> .env.production
          echo "JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}" >> .env.production
          echo "JWT_REFRESH_EXPIRATION=${{ secrets.JWT_REFRESH_EXPIRATION }}" >> .env.production

          # Firebase (handle newline sequences correctly)
          echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env.production
          echo "FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}" >> .env.production
          # FIREBASE_PRIVATE_KEY may contain \n sequences stored in secret; use printf '%b' to expand \n into real newlines when writing.
          echo "FIREBASE_PRIVATE_KEY=${{ secrets.FIREBASE_PRIVATE_KEY }}" >> .env.production

          # SMTP / Email
          echo "SMTP_HOST=${{ secrets.SMTP_HOST }}" >> .env.production
          echo "SMTP_PORT=${{ secrets.SMTP_PORT }}" >> .env.production
          echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> .env.production
          echo "SMTP_PASS=${{ secrets.SMTP_PASS }}" >> .env.production
          echo "SMTP_FROM=${{ secrets.SMTP_FROM }}" >> .env.production
          echo "SMTP_FROM_NAME=${{ secrets.SMTP_FROM_NAME }}" >> .env.production

          # Frontend / Misc
          echo "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" >> .env.production

          # Show a small masked preview for logs (no secret values)
          echo "-> .env.production generated (length bytes): $(wc -c < .env.production)"
          echo "-> First lines:"
          head -n 12 .env.production | sed -n '1,12p'

      - name: Copy .env.production to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT || '22' }}
          source: ".env.production"
          target: "/home/yamohub/.env.production"

      - name: Deploy on server (pull image, update container)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT || '22' }}
          script: |
            set -euo pipefail
            cd /home/yamohub

            echo "Ensure .env.production permissions..."
            sudo chown $USER:$USER .env.production || true
            sudo chmod 600 .env.production || true

            echo "Pulling latest image: $IMAGE_NAME"
            docker compose pull yamohub-api

            echo "Restarting yamohub-api container"
            docker compose up -d yamohub-api

            echo "Wait a few seconds for container to start..."
            sleep 5

            echo "Pruning dangling images"
            docker image prune -f || true

            echo "Deployment finished."
